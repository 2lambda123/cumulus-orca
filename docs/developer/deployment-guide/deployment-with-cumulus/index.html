<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.69">
<title data-react-helmet="true">Deploying ORCA with Cumulus | Operational Recovery Cloud Archive (ORCA)</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_language" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Deploying ORCA with Cumulus | Operational Recovery Cloud Archive (ORCA)"><meta data-react-helmet="true" name="description" content="Provides developer information for ORCA code deployment with Cumulus."><meta data-react-helmet="true" property="og:description" content="Provides developer information for ORCA code deployment with Cumulus."><meta data-react-helmet="true" property="og:url" content="https://nasa.github.io/cumulus-orca//cumulus-orca/docs/developer/deployment-guide/deployment-with-cumulus"><link data-react-helmet="true" rel="shortcut icon" href="/cumulus-orca/static/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://nasa.github.io/cumulus-orca//cumulus-orca/docs/developer/deployment-guide/deployment-with-cumulus"><link rel="stylesheet" href="/cumulus-orca/styles.cb12f2af.css">
<link rel="preload" href="/cumulus-orca/styles.2804a396.js" as="script">
<link rel="preload" href="/cumulus-orca/runtime~main.f95caf9f.js" as="script">
<link rel="preload" href="/cumulus-orca/main.e61d1c0e.js" as="script">
<link rel="preload" href="/cumulus-orca/2.d11a7cb2.js" as="script">
<link rel="preload" href="/cumulus-orca/41.a305bff1.js" as="script">
<link rel="preload" href="/cumulus-orca/42.5130413a.js" as="script">
<link rel="preload" href="/cumulus-orca/935f2afb.76d5b5c6.js" as="script">
<link rel="preload" href="/cumulus-orca/40.b82529ab.js" as="script">
<link rel="preload" href="/cumulus-orca/7c9fa1db.3ce0c913.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_2AhQ">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/cumulus-orca/"><img src="/cumulus-orca/static/img/cumulus-orca-logo.svg" alt="ORCA site logo" class="themedImage_2E_h themedImage--light_AouX navbar__logo"><img src="/cumulus-orca/static/img/cumulus-orca-logo.svg" alt="ORCA site logo" class="themedImage_2E_h themedImage--dark_1YPN navbar__logo"><strong class="navbar__title">Operational Recovery Cloud Archive (ORCA)</strong></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/cumulus-orca/docs/about/introduction/orca-intro">About ORCA</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/cumulus-orca/docs/developer/quickstart/developer-intro">Developer Guide</a><a class="navbar__item navbar__link" href="/cumulus-orca/docs/cookbook/cookbook-intro">ORCA Cookbooks</a><a class="navbar__item navbar__link" href="/cumulus-orca/docs/operator/operator-intro">Operator Guide</a><a href="https://github.com/nasa/cumulus-orca" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/cumulus-orca/"><img src="/cumulus-orca/static/img/cumulus-orca-logo.svg" alt="ORCA site logo" class="themedImage_2E_h themedImage--light_AouX navbar__logo"><img src="/cumulus-orca/static/img/cumulus-orca-logo.svg" alt="ORCA site logo" class="themedImage_2E_h themedImage--dark_1YPN navbar__logo"><strong class="navbar__title">Operational Recovery Cloud Archive (ORCA)</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/cumulus-orca/docs/about/introduction/orca-intro">About ORCA</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/cumulus-orca/docs/developer/quickstart/developer-intro">Developer Guide</a></li><li class="menu__list-item"><a class="menu__link" href="/cumulus-orca/docs/cookbook/cookbook-intro">ORCA Cookbooks</a></li><li class="menu__list-item"><a class="menu__link" href="/cumulus-orca/docs/operator/operator-intro">Operator Guide</a></li><li class="menu__list-item"><a href="https://github.com/nasa/cumulus-orca" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_2gpo"><main class="docMainContainer_3EyW"><div class="container padding-vert--lg docItemWrapper_39qw"><div class="row"><div class="col docItemCol_2ASc"><div class="docItemContainer_3QWW"><article><header><h1 class="docTitle_1Lrw">Deploying ORCA with Cumulus</h1></header><div class="markdown"><ul><li>Assumptions about OU setup, access, etc.</li><li>Setup environment</li><li>Create Glacier S3 bucket</li><li>Followed Cumulus directions</li></ul><p>ORCA Deployment</p><p>aws configure --profile default</p><p>aws s3api create-bucket --bucket orca-bh-sandbox-glacier --profile dr-ou  --create-bucket-configuration &quot;LocationConstraint=us-west-2&quot;
aws s3api put-bucket-versioning  --bucket orca-bh-sandbox-tf-state --versioning-configuration Status=Enabled</p><p>Changes to files</p><ul><li>main.tf</li><li>variables.tf</li><li>variables.tfvars</li></ul><p>Terraform deploy</p><ul><li>terraform init</li><li>terraform apply</li></ul><p>aws ssm start-session --target i-0650c326450164b73 --document-name AWS-StartPortForwardingSession --parameters portNumber=22,localPortNumber=6868 &amp;
Ssh</p><p>ENABLE_RECOVERY=true APIROOT=<a href="https://acryfz64bj.execute-api.us-west-2.amazonaws.com/dev/" target="_blank" rel="noopener noreferrer">https://acryfz64bj.execute-api.us-west-2.amazonaws.com/dev/</a> npm run serve</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="configure-the-terraform-backend"></a>Configure the Terraform backend<a class="hash-link" href="#configure-the-terraform-backend" title="Direct link to heading">#</a></h2><p>The state of the Terraform deployment is stored in S3. In the following
examples, it will be assumed that state is being stored in a bucket called
<code>dr-tf-state</code>. You can also use an existing bucket, if desired.</p><p>Create the state bucket:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-shell codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">aws s3api create-bucket --bucket dr-tf-state --create-bucket-configuration </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">LocationConstraint</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">us-west-2</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p><strong>Note:</strong> The <code>--create-bucket-configuration</code> line is only necessary if you are creating your bucket outside of <code>us-east-1</code>.</p><p>In order to help prevent loss of state information, it is recommended that
versioning be enabled on the state bucket:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-shell codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ aws s3api put-bucket-versioning </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    --bucket dr-tf-state </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    --versioning-configuration </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">Status</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">Enabled</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>Terraform uses a lock stored in DynamoDB in order to prevent multiple
simultaneous updates. In the following examples, that table will be called
<code>dr-tf-locks</code>.</p><p>Create the locks table:</p><p>⚠️ <strong>Note:</strong> The <code>--billing-mode</code> option was recently added to the AWS CLI. You
may need to upgrade your version of the AWS CLI if you get an error about
provisioned throughput when creating the table.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-shell codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ aws dynamodb create-table </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    --table-name dr-tf-locks </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    --attribute-definitions </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">AttributeName</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">LockID,AttributeType</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">S </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    --key-schema </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">AttributeName</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">LockID,KeyType</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">HASH </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    --billing-mode PAY_PER_REQUEST</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="configure-and-deploy-the-main-root-module"></a>Configure and deploy the <code>main</code> root module<a class="hash-link" href="#configure-and-deploy-the-main-root-module" title="Direct link to heading">#</a></h2><p>These steps should be executed in the root directory of the repo.</p><p>Create a <code>terraform.tf</code> file, substituting the appropriate values for <code>bucket</code>
and <code>dynamodb_table</code>. This tells Terraform where to store its
remote state.</p><p><strong>terraform.tf</strong></p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">terraform {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  backend &quot;s3&quot; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    region         = &quot;us-west-2&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    bucket         = &quot;dr-tf-state&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    key            = &quot;terraform.tfstate&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    dynamodb_table = &quot;dr-tf-locks&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="variables"></a>Variables<a class="hash-link" href="#variables" title="Direct link to heading">#</a></h2><p>First, run a <code>mv terraform.tfvars.example terraform.tfvars</code> to get a template <code>terraform.tfvars</code> in your working directory. This is where you will place input variables to Terraform.</p><p><strong>Necessary:</strong></p><ul><li><code>ngap_subnets</code> - NGAP Subnets (array)</li><li><code>vpc_id</code> - ID of VPC to place resources in - recommended that this be a private VPC (or at least one with restricted access).</li><li><code>glacier_bucket</code> - Bucket with Glacier policy</li><li><code>public_bucket</code> - Bucket with public permissions (Cumulus public bucket)</li><li><code>private_bucket</code> - Bucket with private permissions (Cumulus private bucket)</li><li><code>internal_bucket</code> - Analogous to the Cumulus internal bucket </li><li><code>protected_bucket</code> - Analogous to the Cumulus protected bucket</li><li><code>permissions_boundary_arn</code> - Permission Boundary Arn (Policy) for NGAP compliance</li><li><code>postgres_user_pw</code> - password for the postgres user</li><li><code>database_name</code> - disaster_recovery</li><li><code>database_app_user</code> - druser </li><li><code>database_app_user_pw</code> - the password for the application user</li></ul><p><strong>Optional:</strong></p><ul><li><code>prefix</code> - Prefix that will be pre-pended to resource names created by terraform.
Defaults to <code>dr</code>.</li><li><code>profile</code> - AWS CLI Profile (configured via <code>aws configure</code>) to use.
Defaults to <code>default</code>.</li><li><code>region</code> - Your AWS region.
Defaults to <code>us-west-2</code>.</li><li><code>restore_expire_days</code> - How many days to restore a file for.
Defaults to 5.</li><li><code>restore_request_retries</code> - How many times to retry a restore request to Glacier.
Defaults to 3.</li><li><code>restore_retry_sleep_secs</code> - How many seconds to wait between retry calls to <code>restore_object</code>.
Defaults to 3.</li><li><code>restore_retrieval_type</code> -  the Tier for the restore request. Valid values are &#x27;Standard&#x27;|&#x27;Bulk&#x27;|&#x27;Expedited&#x27;.
Defaults to <code>Standard</code>. Understand the costs associated with the tiers before modifying.</li><li><code>copy_retries</code> - How many times to retry a copy request from the restore location to the archive location.
Defaults to 3.</li><li><code>copy_retry_sleep_secs</code> - How many seconds to wait between retry calls to <code>copy_object</code>.
Defaults to 0.</li><li><code>ddl_dir</code> - the location of the ddl dir that contains the sql to create the application database.
Defaults to &#x27;ddl/&#x27;.</li><li><code>drop_database</code> - Whether to drop the database if it exists (True), or keep it (False).
Defaults to False.</li><li><code>database_port</code> - the port for the postgres database.
Defaults to &#x27;5432&#x27;.</li><li><code>platform</code> - indicates if running locally (onprem) or in AWS (AWS).
Defaults to &#x27;AWS&#x27;.</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="deploying-with-terraform"></a>Deploying with Terraform<a class="hash-link" href="#deploying-with-terraform" title="Direct link to heading">#</a></h2><p>Run <code>terraform init</code>.
Run <code>terraform plan</code> #optional, but allows you to preview the deploy.
Run <code>terraform apply</code>.</p><p>This will deploy ORCA.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="delete-terraform-stack"></a>Delete Terraform stack<a class="hash-link" href="#delete-terraform-stack" title="Direct link to heading">#</a></h2><p>If you want to remove it:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">terraform destroy</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="integrating-with-cumulus"></a>Integrating with Cumulus<a class="hash-link" href="#integrating-with-cumulus" title="Direct link to heading">#</a></h2><p>Integrate ORCA with Cumulus to be able to recover a granule from the Cumulus Dashboard.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="define-the-orca-workflow-cumulus--v115"></a>Define the ORCA workflow (Cumulus &lt; v1.15)<a class="hash-link" href="#define-the-orca-workflow-cumulus--v115" title="Direct link to heading">#</a></h3><p>Copy the workflow from <code>workflows/workflows.yml.dr</code> into your Cumulus workflow.</p><p>Set the values of these environment variables to the ARN for the
{prefix}-extract-filepaths-for-granule and {prefix}-request-files lambdas,
respectively:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">DR_EXTRACT_LAMBDA_ARN=arn:aws:lambda:us-west-2:012345678912:function:dr_extract_filepaths_for_granule</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">DR_REQUEST_LAMBDA_ARN=arn:aws:lambda:us-west-2:012345678912:function:dr_request_files</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>Add an <code>aws</code> provider to <code>main.tf</code>:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">provider &quot;aws&quot; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  version = &quot;~&gt; 2.13&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  region  = var.region</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  profile = var.profile</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="integrating-orca-with-cumulus--v115"></a>Integrating ORCA With Cumulus &gt;= v1.15<a class="hash-link" href="#integrating-orca-with-cumulus--v115" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="adding-a-orca-module-to-the-cumulus-deployment"></a>Adding a ORCA module to the Cumulus deployment<a class="hash-link" href="#adding-a-orca-module-to-the-cumulus-deployment" title="Direct link to heading">#</a></h4><p>Navigate to <code>cumulus-tf/main.tf</code> within your Cumulus deployment directory and add the following module:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">module &quot;orca&quot; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  source = &quot;https://github.com/ghrcdaac/operational-recovery-cloud-archive/releases/download/1.0.2/orca-1.0.2.zip&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  prefix = var.prefix</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  subnet_ids = module.ngap.ngap_subnets_ids</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  database_port = &quot;5432&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  database_user_pw = var.database_user_pw</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  database_name = var.database_name</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  database_app_user = var.database_app_user</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  database_app_user_pw = var.database_app_user_pw</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ddl_dir = &quot;ddl/&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  drop_database = &quot;False&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  platform = &quot;AWS&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  lambda_timeout = 300</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  restore_complete_filter_prefix = &quot;&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  vpc_id = module.ngap.ngap_vpc.id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  copy_retry_sleep_secs = 2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  permissions_boundary_arn = var.permissions_boundary_arn</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  buckets = var.buckets</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  workflow_config = module.cumulus.workflow_config</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  region = var.region</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p><em>Note</em>: This above snippet assumes that you&#x27;ve configured your Cumulus deployment. More information on that process can be found in their <a href="https://nasa.github.io/cumulus/docs/deployment/deployment-readme#configure-and-deploy-the-cumulus-tf-root-module" target="_blank" rel="noopener noreferrer">documentation</a></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="add-necessary-variables-unique-to-orca-to-the-cumulus-tf-configuration"></a>Add necessary variables (unique to ORCA) to the Cumulus TF configuration<a class="hash-link" href="#add-necessary-variables-unique-to-orca-to-the-cumulus-tf-configuration" title="Direct link to heading">#</a></h4><p>To support this module, you&#x27;ll have to add the following values to your <code>cumulus-tf/variables.tf</code> file:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Variables specific to ORCA</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">variable &quot;database_user_pw&quot; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  type = string</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">variable &quot;database_name&quot; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  type = string</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">variable &quot;database_app_user&quot; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  type = string</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">variable &quot;database_app_user_pw&quot; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  type = string</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>The values corresponding to these variables must be set in your <code>cumulus-tf/terraform.tfvars</code> file, but note that many of these variables are actually hardcoded at the time of updating this README</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="adding-the-copy-to-glacier-step-to-the-ingest-workflow"></a>Adding the Copy To Glacier Step to the Ingest Workflow<a class="hash-link" href="#adding-the-copy-to-glacier-step-to-the-ingest-workflow" title="Direct link to heading">#</a></h4><p>Navigate to <code>cumulus-tf/ingest_granule_workflow.tf</code> then add the following step after the PostToCMR step being sure to change the PostToCMR&#x27;s &quot;Next&quot; parameter equal to &quot;CopyToGlacier&quot;</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;CopyToGlacier&quot;:{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         &quot;Parameters&quot;:{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;cma&quot;:{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">               &quot;event.$&quot;:&quot;$&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">               &quot;task_config&quot;:{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                  &quot;bucket&quot;:&quot;{$.meta.buckets.internal.name}&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                  &quot;buckets&quot;:&quot;{$.meta.buckets}&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                  &quot;distribution_endpoint&quot;:&quot;{$.meta.distribution_endpoint}&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                  &quot;files_config&quot;:&quot;{$.meta.collection.files}&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                  &quot;fileStagingDir&quot;:&quot;{$.meta.collection.url_path}&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                  &quot;granuleIdExtraction&quot;:&quot;{$.meta.collection.granuleIdExtraction}&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                  &quot;collection&quot;:&quot;{$.meta.collection}&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                  &quot;cumulus_message&quot;:{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                     &quot;input&quot;:&quot;{[$.payload.granules[*].files[*].filename]}&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                     &quot;outputs&quot;:[</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                           &quot;source&quot;:&quot;{$}&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                           &quot;destination&quot;:&quot;{$.payload}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                     ]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">               }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         &quot;Type&quot;:&quot;Task&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         &quot;Resource&quot;:&quot;${module.orca.copy_to_glacier_lambda_arn}&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         &quot;Catch&quot;:[</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">               &quot;ErrorEquals&quot;:[</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                  &quot;States.ALL&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">               ],</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">               &quot;ResultPath&quot;:&quot;$.exception&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">               &quot;Next&quot;:&quot;WorkflowFailed&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         ],</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         &quot;Retry&quot;:[</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">               &quot;ErrorEquals&quot;:[</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                  &quot;States.ALL&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">               ],</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">               &quot;IntervalSeconds&quot;:2,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">               &quot;MaxAttempts&quot;:3</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         ],</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         &quot;Next&quot;:&quot;WorkflowSucceeded&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      },</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="collection-configuration"></a>Collection configuration<a class="hash-link" href="#collection-configuration" title="Direct link to heading">#</a></h3><p>To configure a collection to enable ORCA, add the line
<code>&quot;granuleRecoveryWorkflow&quot;: &quot;DrRecoveryWorkflow&quot;</code> to the collection configuration:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;queriedAt&quot;: &quot;2019-11-07T22:49:46.842Z&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;name&quot;: &quot;L0A_HR_RAW&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;version&quot;: &quot;1&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;sampleFileName&quot;: &quot;L0A_HR_RAW_product_0001-of-0420.h5&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;dataType&quot;: &quot;L0A_HR_RAW&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;granuleIdExtraction&quot;: &quot;^(.*)((\\.cmr\\.json)|(\\.iso\\.xml)|(\\.tar\\.gz)|(\\.h5)|(\\.h5\\.mp))$&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;reportToEms&quot;: true,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;createdAt&quot;: 1561749178492,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;granuleId&quot;: &quot;^.*$&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;provider_path&quot;: &quot;L0A_HR_RAW/&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;meta&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;response-endpoint&quot;: &quot;arn:aws:sns:us-west-2:012345678912:providerResponseSNS&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;granuleRecoveryWorkflow&quot;: &quot;DrRecoveryWorkflow&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;files&quot;: [</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="enable-recover-granule-button"></a>Enable <code>Recover Granule</code> button<a class="hash-link" href="#enable-recover-granule-button" title="Direct link to heading">#</a></h3><p>To enable the <code>Recover Granule</code> button on the Cumulus Dashboard (available at github.com/nasa/cumulus-dashboard),
set the environment variable <code>ENABLE_RECOVERY=true</code>.</p><p>Here is an example command to run the Cumulus Dashboard locally:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">  APIROOT=https://uttm5y1jcj.execute-api.us-west-2.amazonaws.com:8000/dev ENABLE_RECOVERY=true npm run serve</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="release-documentation"></a>Release Documentation:<a class="hash-link" href="#release-documentation" title="Direct link to heading">#</a></h2><p>Information about how to create an ORCA release can be found here</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/nasa/cumulus-orca/edit/develop/website/docs/developer/deployment-guide/deployment-with-cumulus.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3SO_ thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#configure-the-terraform-backend" class="table-of-contents__link">Configure the Terraform backend</a></li><li><a href="#configure-and-deploy-the-main-root-module" class="table-of-contents__link">Configure and deploy the <code>main</code> root module</a></li><li><a href="#variables" class="table-of-contents__link">Variables</a></li><li><a href="#deploying-with-terraform" class="table-of-contents__link">Deploying with Terraform</a></li><li><a href="#delete-terraform-stack" class="table-of-contents__link">Delete Terraform stack</a></li><li><a href="#integrating-with-cumulus" class="table-of-contents__link">Integrating with Cumulus</a><ul><li><a href="#define-the-orca-workflow-cumulus--v115" class="table-of-contents__link">Define the ORCA workflow (Cumulus &lt; v1.15)</a></li><li><a href="#integrating-orca-with-cumulus--v115" class="table-of-contents__link">Integrating ORCA With Cumulus &gt;= v1.15</a></li><li><a href="#collection-configuration" class="table-of-contents__link">Collection configuration</a></li><li><a href="#enable-recover-granule-button" class="table-of-contents__link">Enable <code>Recover Granule</code> button</a></li></ul></li><li><a href="#release-documentation" class="table-of-contents__link">Release Documentation:</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/cumulus-orca/docs/about/introduction/orca-intro">About ORCA</a></li><li class="footer__item"><a class="footer__link-item" href="/cumulus-orca/docs/developer/quickstart/developer-intro">ORCA Developer Guide</a></li><li class="footer__item"><a class="footer__link-item" href="/cumulus-orca/docs/cookbook/cookbook-intro">ORCA Cookbooks</a></li><li class="footer__item"><a class="footer__link-item" href="/cumulus-orca/docs/operator/operator-intro">ORCA Operator Guide</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://wiki.earthdata.nasa.gov/display/CUMULUS/ORCA+Working+Group" target="_blank" rel="noopener noreferrer" class="footer__link-item">ORCA Working Group</a></li><li class="footer__item"><a href="https://github.com/nasa/cumulus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cumulus Project</a></li><li class="footer__item"><a href="https://wiki.earthdata.nasa.gov/display/CUMULUS/Cumulus+Integrators+Working+Group" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cumulus Integrator Working Group</a></li><li class="footer__item"><a href="https://wiki.earthdata.nasa.gov/display/CUMULUS/Cumulus+Operator+Working+Group" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cumulus Operator Working Group</a></li><li class="footer__item"><a href="https://nasa.github.io/cumulus/docs/cumulus-docs-readme" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cumulus Documentation</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a href="https://github.com/nasa/cumulus-orca" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="text--center"><div></div></div></div></footer></div>
<script src="/cumulus-orca/styles.2804a396.js"></script>
<script src="/cumulus-orca/runtime~main.f95caf9f.js"></script>
<script src="/cumulus-orca/main.e61d1c0e.js"></script>
<script src="/cumulus-orca/2.d11a7cb2.js"></script>
<script src="/cumulus-orca/41.a305bff1.js"></script>
<script src="/cumulus-orca/42.5130413a.js"></script>
<script src="/cumulus-orca/935f2afb.76d5b5c6.js"></script>
<script src="/cumulus-orca/40.b82529ab.js"></script>
<script src="/cumulus-orca/7c9fa1db.3ce0c913.js"></script>
</body>
</html>